on:
  pull_request:
  push:
    branches:
      - master

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_DEFAULT_REGION: ap-northeast-1

jobs:
  test_cache_miss_and_upload:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: npm ci
      - name: set up node.js 10
        uses: actions/setup-node@v1.4.0
        with:
          node-version: 10.x
      - name: assert cache miss
        uses: ./
        with:
          s3-bucket: ${{ secrets.S3Bucket }}
          cache-key: npm-v1-${{ hashFiles('test/package-lock.json') }}-${{ env.GITHUB_RUN_ID }}
          paths: node_modules
          command: npm ci
          zip-option: -ryq
          unzip-opton: -n
          working-directory: test
      - run: test -d test/node_modules
      - name: assert cache exit
        run: aws s3 ls s3://${{ secrets.S3Bucket }}/npm-v1-${{ hashFiles('test/package-lock.json') }}-${{ env.GITHUB_RUN_ID }}.zip

  test_cache_hit:
    needs: [test_cache_miss_and_upload]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: npm ci
      - name: set up node.js 10
        uses: actions/setup-node@v1.4.0
        with:
          node-version: 10.x
      - name: assert cache hit
        uses: ./
        with:
          s3-bucket: ${{ secrets.S3Bucket }}
          cache-key: npm-v1-${{ hashFiles('test/package-lock.json') }}-${{ env.GITHUB_RUN_ID }}
          paths: node_modules
          command: npm ci
          zip-option: -ryq
          unzip-opton: -n
          working-directory: test
      - run: test -d test/node_modules
      - name: clean up
        run: aws s3 rm s3://${{ secrets.S3Bucket }}/npm-v1-${{ hashFiles('test/package-lock.json') }}-${{ env.GITHUB_RUN_ID }}.zip
